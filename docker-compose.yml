version: "3.9"

services:
  # MeiliSearch Service
  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: meilisearch-demo-service
    restart: unless-stopped
    command: >
      meilisearch
      --env production
      --master-key "${MEILI_MASTER_KEY:-}"
      --schedule-snapshot
      --snapshot-dir /meili_data/snapshots
    ports:
      - "${MEILI_PORT:-7700}:7700" # host:container
    volumes:
      - meili_data:/meili_data
    networks:
      - semantic-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sSf http://localhost:7700/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama Service (For Nomic-Embed-Text)
  ollama:
    image: ollama/ollama:0.13.1-rc0
    container_name: ollama-demo-service
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    networks:
      - semantic-net
    command: >
      bash -c "
      ollama serve &
      until curl -s http://localhost:11434/api/tags >/dev/null; do
        echo 'Waiting for Ollama...'; sleep 1;
      done;
      ollama pull nomic-embed-text &&
      wait
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Backend Service (Your .NET API from server)
  backend:
    build:
      context: ./server/Bloggy  # Points to the server folder for the backend code
      dockerfile: Bloggy.Api/Dockerfile  # Path to Dockerfile relative to context
    container_name: backend-demo-service
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5010}:5010"
    environment:
      ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT:-Development}"
      MEILI_URL: "http://meilisearch:7700"
      MEILI_API_KEY: "${MEILI_API_KEY:-}"
      MEILI_SEARCH_API: "${MEILI_SEARCH_API:-}"
      ASPNETCORE_URLS: "http://+:5010"
      OLLAMA_URL: "http://ollama:11434"
      VITE_FRONTEND_URL: "http://frontend-demo-service:5173"
    depends_on:
      meilisearch:
        condition: service_healthy
      ollama:
        condition: service_healthy
    networks:
      - semantic-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5010/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Frontend Service (React + Vite from client)
  frontend:
    build:
      context: ./client  # Points to the client folder for the frontend code
      dockerfile: Dockerfile  # Path to Dockerfile relative to context
    container_name: frontend-demo-service
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-5173}:5173"  # Default Vite port is 5173
    environment:
      VITE_BACKEND_URL: "http://backend-demo-service:5010"  # Set the backend URL for the frontend to consume the API
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - semantic-net

volumes:
  meili_data:
  ollama_models:

networks:
  semantic-net:
    driver: bridge
